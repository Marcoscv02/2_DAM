# 1. Lenguaje de Consulta de Jakarta Persistence (JPQL) üìù

La API de Persistencia de Jakarta ofrece **dos m√©todos** para consultar entidades:

- **Jakarta Persistence QL** (JPQL)
- **API Criteria**

---

## 1.1. Jakarta Persistence QL

- **Descripci√≥n:**  
    Jakarta Persistence QL es el lenguaje de consulta est√°ndar basado en _String_ de la API de Persistencia de Jakarta.
- **Caracter√≠sticas:**
    - <span style="color:rgb(0, 112, 192)"><b>Portable</b></span>******: Las consultas se pueden compilar de forma portable a SQL en cualquier servidor de bases de datos principal.
    - <span style="color:rgb(0, 112, 192)"><b>Orientado a Objetos</b></span>: Combina la sintaxis y sem√°ntica de SQL con la de un lenguaje de expresi√≥n orientado a objetos.
-  ‚úÖ**Ventaja:**
    - F√°cil de aprender para quienes ya conocen SQL.

---

## 1.2. API de Criterios

- **Descripci√≥n:**  
    La API Criteria se utiliza para <u>construir consultas **seguras</u> en cuanto a tipos** utilizando la API del lenguaje de programaci√≥n Java.
>- **Nota:**
> 	- **En estos apuntes nos centraremos en JPQL.**
>	- La API Criteria se estudia en otros contextos, ya que requiere crear objetos y operaciones adicionales para construir la consulta.

---

# 2. Introducci√≥n a Jakarta Persistence QL üöÄ

- **No es SQL:**  
    Aunque comparte palabras clave y una estructura similar, **JPQL no es SQL**.
    
    - Intentar escribir JPQL como si fuera SQL puede llevar a frustraciones.
- **Orientado a Entidades:**
    
    - Se consulta **el modelo de dominio de entidades persistentes** y sus relaciones, no las tablas y filas de la base de datos.
    - Opera sobre el **estado persistente** definido en el modelo de objetos, sin necesidad de conocer la asignaci√≥n f√≠sica a la base de datos.
- **Portabilidad:**
    
    - Al estar escrito en t√©rminos de entidades, JPQL es portable y se traduce a los dialectos SQL de los principales proveedores de bases de datos.
- **Comparaci√≥n: JPQL vs Criteria API**

| <span style="color:rgb(255, 0, 0)">Aspecto</span>                         | <span style="color:rgb(255, 0, 0)">Jakarta Persistence QL (JPQL)</span>                                                                                                                                    | <span style="color:rgb(255, 0, 0)">API de Criterios</span> |
| ------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------- |
| Sintaxis                                                                  | Basado en _String_, similar a SQL.                                                                                                                                                                         | Basado en la creaci√≥n de objetos Java, m√°s verboso.        |
| `List getResultList()`                                                    | Ejecuta la consulta y devuelve una lista de resultados. La lista no es tipada.                                                                                                                             |                                                            |
| `default Stream getResultStream()`                                        | Ejecuta la consulta y devuelve un `Stream` no tipado de resultados. Por defecto, delega a `getResultList().stream()`, aunque proveedores como Hibernate pueden sobrescribirlo para mejorar el rendimiento. |                                                            |
| `Object getSingleResult()`                                                | Ejecuta la consulta y devuelve un √∫nico resultado. Si la consulta devuelve m√°s de uno, lanza una excepci√≥n `NonUniqueResultException`.                                                                     |                                                            |
| `Query setFirstResult(int startPosition)`                                 | Establece la posici√≥n del primer resultado a recuperar, √∫til para paginaci√≥n.                                                                                                                              |                                                            |
| `Query setMaxResults(int maxResult)`                                      | Establece el n√∫mero m√°ximo de resultados a recuperar, tambi√©n para paginaci√≥n.                                                                                                                             |                                                            |
| `int getFirstResult()`                                                    | Devuelve la posici√≥n del primer resultado. Retorna 0 si no se ha usado `setFirstResult()`.                                                                                                                 |                                                            |
| `Query setParameter(int position, Object value)`                          | Asigna un valor a un par√°metro de la consulta por posici√≥n.                                                                                                                                                |                                                            |
| `Query setParameter(String name, Object value)`                           | Asigna un valor a un par√°metro de la consulta por nombre.                                                                                                                                                  |                                                            |
| `Query setParameter(int position, Date value, TemporalType temporalType)` | Asigna un valor a un par√°metro de tipo temporal (`java.util.Date`) a la consulta.                                                                                                                          |                                                            |

- **Caracter√≠sticas adicionales compatibles:**
    
    - Soporta una amplia selecci√≥n de caracter√≠sticas de SQL: subconsultas, consultas de agregados, declaraciones UPDATE y DELETE, numerosas funciones SQL, etc.

---

	## 2.1. Terminolog√≠a üîç

- **Categor√≠as de consultas:**  
    Las consultas en JPQL se dividen en cuatro categor√≠as:
    
    1. **Select:** Recuperan el estado persistente de una o m√°s entidades, con posibilidad de aplicar filtros.
    2. **Aggregate:** Variaciones de las consultas select que agrupan resultados y generan datos resumidos. (Conjuntamente, select y aggregate se denominan _consultas de informes_).
    3. **Update:** Modifican condicionalmente conjuntos de entidades.
    4. **Delete:** Elimina condicionalmente conjuntos de entidades.
- **Esquema de Persistencia Abstracto:**
    
    - Es el conjunto de **entidades y embebidos** definidos por una unidad de persistencia.
    - Define el dominio desde el cual se pueden recuperar resultados en las consultas.
- **Referencias en las expresiones de consulta:**
    
    - Las entidades se refieren por nombre.
        - Si no se especifica un nombre (por ejemplo, mediante el atributo `name` en la anotaci√≥n `@Entity`), se utiliza el nombre de la clase sin calificar.
        - Este nombre se conoce como el **nombre de esquema abstracto** de la entidad.
- **Propiedades de las Entidades:**
    
    - **Campos de estado:**
        - Propiedades simples (sin relaciones) que constituyen el estado persistente de la entidad.
    - **Campos de asociaci√≥n:**
        - Propiedades que representan relaciones con otras entidades.
- **Definici√≥n de consultas:**
    
    - Pueden definirse **din√°micamente** o **est√°ticamente**, dependiendo de las necesidades de la aplicaci√≥n.
- **Sensibilidad a may√∫sculas y min√∫sculas:**
    
    - Las consultas **no distinguen entre may√∫sculas y min√∫sculas**, salvo en dos casos:
        1. Los nombres de entidades.
        2. Los nombres de propiedades.
    - Estos deben especificarse **exactamente** como fueron definidos.

---

## Diagrama Conceptual de JPQL (Mermaid) üé®

mermaid

CopiarEditar

`graph TD     A[Entidades Persistentes]     B[Consultas Select]     C[Consultas Aggregate]     D[Consultas Update]     E[Consultas Delete]     F[Embebidos y Relaciones]          A --> B     A --> C     A --> D     A --> E     A --> F`

---

## Resumen Visual üè∑Ô∏è

- **JPQL:**
    
    - Lenguaje de consulta basado en _String_
    - Portable y orientado a objetos
    - Consulta sobre entidades y sus relaciones
- **API de Criterios:**
    
    - Alternativa m√°s segura en cuanto a tipos
    - Requiere m√°s c√≥digo, ideal para consultas din√°micas complejas
- **Terminolog√≠a clave:**
    
    - **Select, Aggregate, Update, Delete:** Categor√≠as de consultas.
    - **Esquema de Persistencia Abstracto:** Dominio de entidades y embebidos.
    - **Campos de estado vs. Campos de asociaci√≥n:** Diferenciaci√≥n entre propiedades simples y relaciones.